@model P2P.Models.Transaction

@{
    ViewData["Title"] = "Tạo giao dịch";
    var AccountId = Context.Session.GetInt32("AccountId");
    var FeePercent = Context.Session.GetInt32("FeePercent");
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .fade-section {
        transition: opacity 0.6s ease, transform 0.6s ease;
        opacity: 1;
    }

    .fade-out {
        opacity: 0;
        pointer-events: none;
        transform: translateY(10px);
    }

    .fade-in {
        opacity: 1;
        transform: translateY(0);
    }

    .hidden-section {
        display: none;
    }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold">🔒 Tạo Giao Dịch Ký Quỹ</h1>
                <p class="text-muted">Vui lòng điền thông tin chính xác để đảm bảo an toàn cho cả hai bên</p>
            </div>

            <!-- 👇 FORM NHẬP -->
            <div id="formSection" class="card shadow-lg fade-section">
                <div class="card-header bg-primary text-white">
                    <h4>Thông tin giao dịch</h4>
                </div>
                <div class="card-body">
                    <form id="transactionForm">
                        <div class="mb-3">
                            <label class="form-label">💰 Số tiền</label>
                            <input type="text" id="AmountOne" class="form-control form-control-sm material-price" required
                                   placeholder="Nhập số tiền giao dịch (VND)" oninput="formatMoney(event)">
                            <input type="text" id="AmountInput" name="Amount" hidden>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">📝 Mô tả</label>
                            <textarea name="Description" class="form-control" required placeholder="Mô tả nội dung giao dịch..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">⏳ Thời hạn</label>
                            <select name="ExpirationDays" class="form-select" required>
                                <option value="">-- Chọn thời hạn hết hạn --</option>
                                <option value="3">3 ngày</option>
                                <option value="5">5 ngày</option>
                                <option value="10">10 ngày</option>
                                <option value="15">15 ngày</option>
                                <option value="30">30 ngày</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">💳 Phương thức thanh toán</label><br />
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="PaymentMethod" value="BankTransfer" required />
                                <label class="form-check-label">Chuyển khoản ngân hàng</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="PaymentMethod" value="PayPal" required />
                                <label class="form-check-label">Thanh toán qua PayPal</label>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-primary btn-lg" id="previewBtn">
                                Tiếp tục
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            

            <!-- 👇 PHẦN XÁC NHẬN -->
            <div id="confirmationSection" class="card shadow-lg hidden-section fade-section">
                <div class="card-header bg-success text-white">
                    <h4>Xác nhận thông tin giao dịch</h4>
                </div>
                <div class="card-body fs-5">
                    <ul class="list-group list-group-flush mb-4">
                        <li class="list-group-item"><strong>Số tiền:</strong> <span id="confirmAmount"></span></li>
                        <li class="list-group-item"><strong>Mô tả:</strong> <span id="confirmDescription"></span></li>
                        <li class="list-group-item"><strong>Thời hạn:</strong> <span id="confirmExpiration"></span></li>
                        <li class="list-group-item"><strong>Phương thức thanh toán:</strong> <span id="confirmPayment"></span></li>
                    </ul>
                    <h8 style="font-style: italic">Phí chuyển là: @FeePercent %</h8>
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-outline-secondary" id="backBtn">⬅️ Quay lại</button>
                        <button class="btn btn-success" id="confirmBtn">✅ Xác nhận & chuyển tiền</button>
                    </div>
                </div>
            </div>
            <!-- Gợi ý -->
            <div class="mt-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Hệ thống sẽ tạo ra một <strong>Mã bí mật (SecretKey)</strong> sau khi bạn tạo giao dịch thành công.
                    Gửi mã này cho người nhận để họ nhận tiền.
                </div>
            </div>
            <div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1055;">
            </div>
        </div>
    </div>
</div>
@* QR CODE *@
<div id="qrPopup" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow border-0">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Quét mã để chuyển khoản</h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-3">Vui lòng hoàn tất chuyển khoản trong <strong id="countdown" class="text-danger fs-5">10:00</strong></p>
                <img id="qrImage" src="" alt="QR chuyển khoản" class="img-fluid rounded shadow-sm" style="max-width: 350px;">
                <div class="mt-3 text-muted">
                    <small>Quét bằng app ngân hàng để chuyển khoản tự động</small>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    function formatMoney(event) {
        const $input = $(event.target);
        let value = $input.val();

        // Loại bỏ tất cả ký tự không phải số
        value = value.replace(/\D/g, '');

        if (value === '') {
            $input.val('');
            return;
        }

        // Format với dấu chấm
        let formattedValue = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        console.log(formattedValue);
        // Gán lại vào ô input
        $input.val(formattedValue);
    }
</script>
@section Scripts {
    <script>
                $(document).ready(function () {
            const $formSection = $('#formSection');
            const $confirmSection = $('#confirmationSection');
            

            $('#previewBtn').on('click', function () {
                const amountt = $('input[name="Amount"]').val();
                const feePercent = @FeePercent;
                const amount = amountt * (1 + feePercent / 100);
                const desc = $('textarea[name="Description"]').val();
                const expire = $('select[name="ExpirationDays"] option:selected').text();
                const method = $('input[name="PaymentMethod"]:checked').next().text();

                if (!amount || !desc || !$('input[name="PaymentMethod"]:checked').val() || $('select[name="ExpirationDays"]').val() == '') {
                    showToast("Vui lòng điền đầy đủ thông tin.", "error");
                    return;
                }

                // Cập nhật nội dung
                $('#confirmAmount').text(`${parseInt(amount).toLocaleString()} VNĐ`);
                $('#confirmDescription').text(desc);
                $('#confirmExpiration').text(expire);
                $('#confirmPayment').text(method);

                // Ẩn form, hiện confirm
                $formSection.removeClass('fade-in').addClass('fade-out');
                setTimeout(() => {
                    $formSection.addClass('hidden-section').removeClass('fade-out');

                    $confirmSection.removeClass('hidden-section fade-out').addClass('fade-in');
                }, 500);
            });

            $('#backBtn').on('click', function () {
                $confirmSection.removeClass('fade-in').addClass('fade-out');
                setTimeout(() => {
                    $confirmSection.addClass('hidden-section').removeClass('fade-out');

                    $formSection.removeClass('hidden-section fade-out').addClass('fade-in');
                }, 500);
            });

            function showToast(message, type = "success") {
                const toastId = "toast-" + Date.now();

                let bgColor = "bg-success";
                let iconHtml = '<i class="fas fa-check-circle me-2 text-white"></i>'; // Icon mặc định

                if (type === "error" || type === "danger") {
                    bgColor = "bg-danger";
                    iconHtml = '<i class="fas fa-exclamation-triangle me-2 text-warning"></i>';
                }

                const toastHtml = `
                            <div id="${toastId}" class="toast align-items-center text-white ${bgColor} border-0 show mb-2 shadow" role="alert" aria-live="assertive" aria-atomic="true"
                                 style="min-width: 320px;">
                                <div class="d-flex">
                                    <div class="toast-body d-flex align-items-center">
                                        ${iconHtml}
                                        <span>${message}</span>
                                    </div>
                                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                            </div>`;

                $("#toast-container").append(toastHtml);

                // Tự động ẩn sau 4 giây
                setTimeout(() => {
                    $(`#${toastId}`).fadeOut(300, function () {
                        $(this).remove();
                    });
                }, 3000);
            }
        });

        function formatMoney(event) {
                    const $input = $(event.target);
                let value = $input.val();

                // Loại bỏ tất cả ký tự không phải số
                let rawValue = value.replace(/\D/g, '');

                // Nếu rỗng thì clear cả 2 ô input
                if (rawValue === '') {
                    $input.val('');
                    $('#AmountInput').val('');
                    return;
                }

                // Thêm dấu chấm hàng nghìn
                let formattedValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

                // Gán lại vào AmountOne (hiển thị đẹp)
                $input.val(String(formattedValue));

                // Xóa dấu chấm từ formattedValue để lấy số thuần
                let cleanValue = formattedValue.replace(/\./g, '');

                // Gán lại vào AmountInput (ẩn, để gửi form)
                $('#AmountInput').val(cleanValue);

                 }
                 
                

        $('#confirmBtn').click(function () {
            const amountt = $('input[name="Amount"]').val();
            const feePercent = @FeePercent;
            const amount = amountt * (1 + feePercent / 100);
            const accountId = @AccountId;
            const now = new Date();
            const timestamp = `${now.getHours()}${now.getMinutes()}${now.getSeconds()}`;
            const description = `${accountId}${timestamp}`;
            const qrImageUrl = `https://img.vietqr.io/image/MB-0868090203-compact2.png?amount=${amount}&addInfo=${description}&accountName=HA VAN SANG`;

            // Cập nhật QR và hiển thị modal
            $('#qrImage').attr('src', qrImageUrl);

            const qrModal = new bootstrap.Modal(document.getElementById('qrPopup'));
            qrModal.show();
            $('#qrPopup').on('hidden.bs.modal', function () {
                    clearInterval(countdownInterval);
                    clearInterval(checkInterval)
                    console.log("Đã đóng popup");
                });
            // Đếm ngược
            let timeLeft = 600; // 10 phút
            const countdownEl = $('#countdown'); // Đúng ID

            const countdownInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdownEl.text(`${minutes}:${seconds.toString().padStart(2, '0')}`);
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(countdownInterval);
                    clearInterval(checkInterval);
                    alert('⛔ Hết thời gian thanh toán. Giao dịch thất bại.');
                }
            }, 1000);

            // Sau 30s bắt đầu kiểm tra giao dịch
            let checkInterval;
            setTimeout(() => {
                checkInterval = setInterval(() => {
                    $.getJSON('/Payment/CheckGoogleSheetTransaction', function (res) {
                        if (res && res.data && res.data.length > 0) {
                            const rows = res.data;
                            for (const row of rows) {
                                const transAmount = parseInt(row.values_0_2);
                                const content = row.values_0_9;

                                if (transAmount === parseInt(amount) && content.includes(description)) {
                                    clearInterval(countdownInterval);
                                    clearInterval(checkInterval);
                                    // alert("✅ Thanh toán thành công!");
                                    showToast("✅ Thanh toán thành công!", "success");
                                    const amount = $('input[name="Amount"]').val();
                                    const desc = $('textarea[name="Description"]').val();
                                    const method = $('input[name="PaymentMethod"]:checked').next().text();

                                    const days = parseInt($('select[name="ExpirationDays"]').val()) || 0;

                                    const now = new Date();
                                    now.setDate(now.getDate() + days);

                                    const yyyy = now.getFullYear();
                                    const mm = String(now.getMonth() + 1).padStart(2, '0');
                                    const dd = String(now.getDate()).padStart(2, '0');

                                    const expiredDate = `${yyyy}-${mm}-${dd}`;


                                    const encodedDesc = encodeURIComponent(desc);
                                    const encodedMethod = encodeURIComponent(method);

                                    const url = `/Transaction/CreateSecretkey?amount=${amount}&accountId=${accountId}&paymentMethod=${encodedMethod}&description=${encodedDesc}&expired=${expiredDate}&feePercent=${feePercent}`;
                                    window.location.href = url;
                                    return;
                                }
                            }
                        }

                    });
                }, 5000);
            }, 30000);
        });
    </script>
}
